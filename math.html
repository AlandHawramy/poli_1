<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ژمارەکان</title>
    <!-- Your Custom CSS Styles -->
    <style>
        /* Define theme colors using CSS variables (Purple theme from Kurdish letters app) */
        :root {
            /* Purple Theme - ڕەنگە مۆرەکان */
            --theme-bg-main: #F3EBFF; /* زۆر کاڵ، وەک لاڤەندەر بۆ پاشبنەما */
            --theme-bg-content: #FFFFFF; /* سپی پاک بۆ ناوەڕۆک */
            --theme-bg-accent: #E6D8FF; /* لاڤەندەرێکی تۆختر بۆ بەشە جیاوازەکان */

            --theme-border-light: #D1BBE6; /* سنوورێکی مۆر کاڵ */
            --theme-border-medium: #BBAACC; /* سنوورێکی مۆر مامناوەند */
            --theme-border-strong: #A38CBF; /* سنوورێکی مۆری تۆختر */
            --theme-border-accent: #8A7BB2; /* سنوورێکی دیارتر بۆ گشتگیر */

            --theme-text-primary: #4B0082; /* ئیندگۆ - مۆرێکی قووڵ و تۆخ بۆ دەقی سەرەکی */
            --theme-text-secondary: #6A1B9A; /* مۆرێکی مامناوەند بۆ دەقی لاوەکی */
            --theme-text-accent: #9932CC; /* ئۆرکیدی تۆخ - مۆرێکی زیندوو بۆ ناونیشان و هایلایتەکان */

            --theme-button-primary-bg: #9932CC; /* ئۆرکیدی تۆخ بۆ پاشبنەمای دوگمەی سەرەکی */
            --theme-button-primary-text: white; /* ڕەنگی سپی بۆ دەقی دوگمەی سەرەکی */
            --theme-button-primary-hover-bg: #B86ED1; /* ئۆرکیدی تۆخی کاڵتر بۆ کاتی جووڵاندنی ماوس بەسەر دوگمەدا */

            --theme-card-bg: #FFFFFF; /* کارتە سپییەکان بۆ خوێندنەوەی ئاسان */
            --theme-card-border: #D1BBE6; /* سنووری مۆر کاڵ بۆ کارتەکان */
            --theme-card-hover-border: #9932CC; /* مۆری سەرەکی لەسەر سنووری کارتەکان کاتێک ماوس دەچێتە سەریان */
        }

        /* Apply font and background to body */
        body {
            font-family: "Vazirmatn", "NRT Reg", "Rudaw", "Unikurd Web", "Tahoma", sans-serif;
            background-color: var(--theme-bg-main);
            color: var(--theme-text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            text-align: right; /* Default text alignment for RTL */
        }

        /* Basic container styling */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
             /* Add transition for the dimming effect */
            transition: opacity 0.3s ease, filter 0.3s ease;
        }

        /* --- NEW STYLE FOR DIMMING THE MAIN CONTENT --- */
        .container.dimmed {
            opacity: 0.4; /* Adjust opacity to your preferred level of dimness */
        
            pointer-events: none; /* Prevent clicks on the dimmed content */
        }
        /* --- END NEW STYLE --- */


         /* Back button style */
        .back-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 1rem;
            left: 1rem; /* Position on the left visually in RTL */
            right: auto; /* Ensure it's not affected by RTL right */
            background-color: var(--theme-bg-accent); /* Use an accent background */
            color: var(--theme-text-accent); /* Use accent text color */
            border: 1px solid var(--theme-border-medium);
            border-radius: 0.5rem; /* Rounded corners */
            padding: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
            z-index: 10; /* Stay on top */
            text-decoration: none; /* Remove underline for links */
        }

        .back-button:hover {
            background-color: var(--theme-border-light); /* Lighter on hover */
            border-color: var(--theme-border-accent);
            transform: translateY(-1px); /* Slight lift on hover */
        }

        .back-button svg {
            width: 1.5rem;
            height: 1.5rem;
            /* Arrow points left in RTL */
            transform: rotate(0deg);
        }
        html[dir="ltr"] .back-button svg {
             transform: rotate(180deg); /* Arrow points left in LTR */
        }

        /* --- Grid Styles for Numbers (0-100) --- */
        .grid-container {
            display: grid;
            gap: 1rem; /* Space between items */
            padding-top: 1rem;
            text-align: center; /* Center grid items text */
            /* Default (Mobile): Aim for more items per row to reduce scroll */
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        }

        .grid-item {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--theme-card-bg);
            border: 1px solid var(--theme-card-border);
            border-radius: 0.75rem; /* Slightly rounded */
            font-size: 2rem; /* Large font size for numbers */
            font-weight: bold;
            color: var(--theme-text-accent);
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none; /* Prevent text selection */
            min-height: 80px; /* Minimum size for touch targets */
            transition: all 0.3s ease, transform 0.3s ease; /* Add transform to transition */
        }

        .grid-item:hover {
            background-color: var(--theme-bg-accent);
            border-color: var(--theme-card-hover-border);
            transform: scale(1.05); /* Slightly enlarge on hover */
        }

        /* Subtle animation for numbers (Applied to the span inside) */
        @keyframes gentle-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .grid-item span {
            display: block; /* Allow transform */
            transform-origin: center; /* Center the transform */
        }
        .grid-item:hover span {
            animation: gentle-pulse 1.5s infinite ease-in-out; /* Apply animation on hover */
        }


        /* --- Modal Styles --- */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Dark semi-transparent overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50; /* Above other content */
            padding: 1rem;
            overflow-y: auto; /* Allow scrolling if modal is taller than screen */
        }

        .modal-content {
            background-color: var(--theme-bg-content);
            border-radius: 1rem; /* Rounded corners */
            padding: 1.5rem;
            max-width: 600px; /* Maximum width */
            width: 100%;
            position: relative; /* Needed for back button positioning */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            text-align: right; /* Align modal content text to the right */
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--theme-text-accent);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        /* Back button inside modal (positioning relative to modal-content) */
        .modal-content .back-button {
            position: absolute;
            top: 1rem;
            left: 1rem; /* Position on the left visually in RTL */
            right: auto;
            padding: 0.35rem; /* Smaller padding */
            background-color: var(--theme-bg-accent);
            color: var(--theme-text-accent); /* Match modal elements */
            border: 1px solid var(--theme-border-medium);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            z-index: 20; /* Ensure it's above modal content */
            transform: none; /* Reset potential rotation from grid-item */
        }
        .modal-content .back-button:hover {
            background-color: var(--theme-border-light);
            border-color: var(--theme-border-accent);
        }

        /* --- Icon Display Area Styles --- */
        .icon-display-area {
            margin-top: 1.5rem;
            padding: 1rem;
            border: 1px solid var(--theme-card-border);
            border-radius: 1rem;
            background-color: var(--theme-card-bg);
            overflow-y: auto; /* Allow vertical scrolling if needed */
            max-height: 400px; /* Limit height to prevent excessive scrolling */
            display: grid; /* Use grid for controlled layout */
            /* gap is defined by the specific column classes below */
            justify-items: center; /* Center items within their grid cells */
            align-items: center;
            /* Default or fallback grid template */
             grid-template-columns: repeat(auto-fit, minmax(20px, 1fr)); /* Fallback */
             gap: 0.5rem; /* Default gap */
        }

        /* --- NEW GRID LAYOUT CLASSES BASED ON USER REQUIREMENT --- */
        .icons-grid-5-per-row {
            grid-template-columns: repeat(5, 1fr); /* Force 5 columns */
            gap: 0.8rem; /* Gap for 5 columns */
        }

        .icons-grid-10-per-row {
            grid-template-columns: repeat(10, 1fr); /* Force 10 columns */
             gap: 0.4rem; /* Gap for 10 columns (smaller gap for more icons) */
        }
         /* END NEW GRID LAYOUT CLASSES */


        /* Define icon sizes */
        .math-icon { object-fit: contain; flex-shrink: 0;}
        .math-icon.small { width: 20px; height: 20px; }
        .math-icon.medium { width: 30px; height: 30px; }
        .math-icon.large { width: 40px; height: 40px; }
        .math-icon.xlarge { width: 50px; height: 50px; }


        /* --- Responsive Adjustments --- */
        @media (min-width: 768px) { /* md breakpoint */
            .container {
                padding: 2rem;
            }
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            }
            .modal-content {
                max-width: 700px; /* Wider modal */
            }
            .modal-content .back-button {
                left: 2rem; /* Position slightly further in on larger screens */
            }
             /* Ensure RTL is handled correctly if needed for the container padding */
            html[dir="rtl"] .modal-content .back-button {
                left: 2rem;
            }
            html[dir="ltr"] .modal-content .back-button {
                left: 2rem;
            }
        }

        @media (min-width: 1024px) { /* lg */
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
             /* Adjust modal max-width for larger screens if needed */
            .modal-content {
                 max-width: 800px;
            }
        }

        /* Hide element when AlpineJS x-cloak is used */
        [x-cloak] { display: none !important; }

        .math-section-title {
            font-size: 1.8rem; /* Slightly larger title for the main section */
            font-weight: bold;
            color: var(--theme-text-accent);
            margin-top: 1rem;
            margin-bottom: 1rem;
            text-align: center; /* Center titles */
        }
         .section-description {
            font-size: 1.1rem;
            color: var(--theme-text-secondary);
            text-align: center;
            margin-bottom: 2rem;
        }
    </style>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="numbersIconApp()">

    <!-- The single back button that always links to index.html -->
    <!-- This button remains visible when the modal is closed -->
    <!-- It uses a standard link to ensure it goes to index.html -->
    <!-- This button hides when modal is open as per original code -->
    <a href="index.html" class="back-button" aria-label="گەڕانەوە بۆ سەرەتا" x-show="!modalOpen">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
         <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
       </svg>
    </a>

    <!-- The main container that holds the title and the grid -->
    <!-- Apply the 'dimmed' class when modalOpen is true -->
    <div class="container" :class="{ 'dimmed': modalOpen }">
        <h1 class="math-section-title">
            ژمارەکان
        </h1>
        <!-- Main Content: Numbers with Icons (0-100) -->
        <!-- Removed x-show="!modalOpen" from here so it remains visible -->
        <div class="grid-container">
            <template x-for="number in numbers" :key="'icon-num-' + number">
                <div class="grid-item" @click="openIconModal(number)">
                    <span x-text="toKurdishDigits(number)" dir="ltr"></span> <!-- Convert to Kurdish digits -->
                </div>
            </template>
        </div>
    </div>

    <!-- Icon Detail Modal -->
    <!-- This remains unchanged, it's shown/hidden by x-if -->
    <template x-if="modalOpen">
        <div class="modal-backdrop" @click.self="closeModalFromUI()"> <!-- Use closeModalFromUI -->
            <div class="modal-content" @click.stop> <!-- Prevent click inside modal from closing it -->
                <!-- Modal Back Button -->
                <!-- This button also uses closeModalFromUI -->
                <button @click="closeModalFromUI()" class="back-button" aria-label="گەڕانەوە">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 15.75L3 12m0 0l3.75-3.75M3 12h18" />
                    </svg>
                </button>

                <h3 class="modal-title">
                    ژمارەی <span x-text="toKurdishDigits(selectedNumberForIcons)" dir="ltr"></span> <!-- Convert to Kurdish digits -->
                </h3>

                <!-- Area to display Icons -->
                <!-- Conditional class based on number size for better layout -->
                <div class="icon-display-area" :class="iconGridClass">
                    <template x-for="(iconSrc, index) in displayedIcons" :key="'icon-item-' + index">
                        <!-- TODO: Replace with actual animal icon image paths -->
                        <img :src="iconSrc" :alt="'Icon ' + (index + 1)" class="math-icon" :class="iconSizeClass">
                    </template>
                    <p x-show="selectedNumberForIcons === 0" class="text-center text-xl" style="color: var(--theme-text-secondary);">هیچ</p>
                </div>
            </div>
        </div>
    </template>

    <!-- Audio elements for Math Numbers (0-100) -->
    <!-- Ensure the src path is correct, e.g., "audio/math/0.wav" -->
    <audio id="sound-0" src="audio/math/0.wav" preload="auto"></audio>
    <audio id="sound-1" src="audio/math/1.mp3" preload="auto"></audio>
    <audio id="sound-2" src="audio/math/2.mp3" preload="auto"></audio>
    <audio id="sound-3" src="audio/math/3.wav" preload="auto"></audio>
    <audio id="sound-4" src="audio/math/4.mp3" preload="auto"></audio>
    <audio id="sound-5" src="audio/math/5.mp3" preload="auto"></audio>
    <audio id="sound-6" src="audio/math/6.mp3" preload="auto"></audio>
    <audio id="sound-7" src="audio/math/7.mp3" preload="auto"></audio>
    <audio id="sound-8" src="audio/math/8.mp3" preload="auto"></audio>
    <audio id="sound-9" src="audio/math/9.mp3" preload="auto"></audio>
    <audio id="sound-10" src="audio/math/10.mp3" preload="auto"></audio>
    <audio id="sound-11" src="audio/math/11.mp3" preload="auto"></audio>
    <audio id="sound-12" src="audio/math/12.mp3" preload="auto"></audio>
    <audio id="sound-13" src="audio/math/13.mp3" preload="auto"></audio>
    <audio id="sound-14" src="audio/math/14.mp3" preload="auto"></audio>
    <audio id="sound-15" src="audio/math/15.mp3" preload="auto"></audio>
    <audio id="sound-16" src="audio/math/16.mp3" preload="auto"></audio>
    <audio id="sound-17" src="audio/math/17.mp3" preload="auto"></audio>
    <audio id="sound-18" src="audio/math/18.mp3" preload="auto"></audio>
    <audio id="sound-19" src="audio/math/19.mp3" preload="auto"></audio>
    <audio id="sound-20" src="audio/math/20.mp3" preload="auto"></audio>
    <audio id="sound-21" src="audio/math/21.mp3" preload="auto"></audio>
    <audio id="sound-22" src="audio/math/22.mp3" preload="auto"></audio>
    <audio id="sound-23" src="audio/math/23.mp3" preload="auto"></audio>
    <audio id="sound-24" src="audio/math/24.mp3" preload="auto"></audio>
    <audio id="sound-25" src="audio/math/25.mp3" preload="auto"></audio>
    <audio id="sound-26" src="audio/math/26.mp3" preload="auto"></audio>
    <audio id="sound-27" src="audio/math/27.mp3" preload="auto"></audio>
    <audio id="sound-28" src="audio/math/28.mp3" preload="auto"></audio>
    <audio id="sound-29" src="audio/math/29.mp3" preload="auto"></audio>
    <audio id="sound-30" src="audio/math/30.mp3" preload="auto"></audio>
    <audio id="sound-31" src="audio/math/31.mp3" preload="auto"></audio>
    <audio id="sound-32" src="audio/math/32.mp3" preload="auto"></audio>
    <audio id="sound-33" src="audio/math/33.mp3" preload="auto"></audio>
    <audio id="sound-34" src="audio/math/34.mp3" preload="auto"></audio>
    <audio id="sound-35" src="audio/math/35.mp3" preload="auto"></audio>
    <audio id="sound-36" src="audio/math/36.mp3" preload="auto"></audio>
    <audio id="sound-37" src="audio/math/37.mp3" preload="auto"></audio>
    <audio id="sound-38" src="audio/math/38.mp3" preload="auto"></audio>
    <audio id="sound-39" src="audio/math/39.mp3" preload="auto"></audio>
    <audio id="sound-40" src="audio/math/40.mp3" preload="auto"></audio>
    <audio id="sound-41" src="audio/math/41.mp3" preload="auto"></audio>
    <audio id="sound-42" src="audio/math/42.mp3" preload="auto"></audio>
    <audio id="sound-43" src="audio/math/43.mp3" preload="auto"></audio>
    <audio id="sound-44" src="audio/math/44.mp3" preload="auto"></audio>
    <audio id="sound-45" src="audio/math/45.mp3" preload="auto"></audio>
    <audio id="sound-46" src="audio/math/46.mp3" preload="auto"></audio>
    <audio id="sound-47" src="audio/math/47.mp3" preload="auto"></audio>
    <audio id="sound-48" src="audio/math/48.mp3" preload="auto"></audio>
    <audio id="sound-49" src="audio/math/49.mp3" preload="auto"></audio>
    <audio id="sound-50" src="audio/math/50.mp3" preload="auto"></audio>
    <audio id="sound-51" src="audio/math/51.mp3" preload="auto"></audio>
    <audio id="sound-52" src="audio/math/52.mp3" preload="auto"></audio>
    <audio id="sound-53" src="audio/math/53.mp3" preload="auto"></audio>
    <audio id="sound-54" src="audio/math/54.mp3" preload="auto"></audio>
    <audio id="sound-55" src="audio/math/55.mp3" preload="auto"></audio>
    <audio id="sound-56" src="audio/math/56.mp3" preload="auto"></audio>
    <audio id="sound-57" src="audio/math/57.mp3" preload="auto"></audio>
    <audio id="sound-58" src="audio/math/58.mp3" preload="auto"></audio>
    <audio id="sound-59" src="audio/math/59.mp3" preload="auto"></audio>
    <audio id="sound-60" src="audio/math/60.mp3" preload="auto"></audio>
    <audio id="sound-61" src="audio/math/61.mp3" preload="auto"></audio>
    <audio id="sound-62" src="audio/math/62.mp3" preload="auto"></audio>
    <audio id="sound-63" src="audio/math/63.mp3" preload="auto"></audio>
    <audio id="sound-64" src="audio/math/64.mp3" preload="auto"></audio>
    <audio id="sound-65" src="audio/math/65.mp3" preload="auto"></audio>
    <audio id="sound-66" src="audio/math/66.mp3" preload="auto"></audio>
    <audio id="sound-67" src="audio/math/67.mp3" preload="auto"></audio>
    <audio id="sound-68" src="audio/math/68.mp3" preload="auto"></audio>
    <audio id="sound-69" src="audio/math/69.mp3" preload="auto"></audio>
    <audio id="sound-70" src="audio/math/70.mp3" preload="auto"></audio>
    <audio id="sound-71" src="audio/math/71.mp3" preload="auto"></audio>
    <audio id="sound-72" src="audio/math/72.mp3" preload="auto"></audio>
    <audio id="sound-73" src="audio/math/73.mp3" preload="auto"></audio>
    <audio id="sound-74" src="audio/math/74.mp3" preload="auto"></audio>
    <audio id="sound-75" src="audio/math/75.mp3" preload="auto"></audio>
    <audio id="sound-76" src="audio/math/76.mp3" preload="auto"></audio>
    <audio id="sound-77" src="audio/math/77.mp3" preload="auto"></audio>
    <audio id="sound-78" src="audio/math/78.mp3" preload="auto"></audio>
    <audio id="sound-79" src="audio/math/79.mp3" preload="auto"></audio>
    <audio id="sound-80" src="audio/math/80.mp3" preload="auto"></audio>
    <audio id="sound-81" src="audio/math/81.mp3" preload="auto"></audio>
    <audio id="sound-82" src="audio/math/82.mp3" preload="auto"></audio>
    <audio id="sound-83" src="audio/math/83.mp3" preload="auto"></audio>
    <audio id="sound-84" src="audio/math/84.mp3" preload="auto"></audio>
    <audio id="sound-85" src="audio/math/85.mp3" preload="auto"></audio>
    <audio id="sound-86" src="audio/math/86.mp3" preload="auto"></audio>
    <audio id="sound-87" src="audio/math/87.mp3" preload="auto"></audio>
    <audio id="sound-88" src="audio/math/88.mp3" preload="auto"></audio>
    <audio id="sound-89" src="audio/math/89.mp3" preload="auto"></audio>
    <audio id="sound-90" src="audio/math/90.mp3" preload="auto"></audio>
    <audio id="sound-91" src="audio/math/91.mp3" preload="auto"></audio>
    <audio id="sound-92" src="audio/math/92.mp3" preload="auto"></audio>
    <audio id="sound-93" src="audio/math/93.mp3" preload="auto"></audio>
    <audio id="sound-94" src="audio/math/94.mp3" preload="auto"></audio>
    <audio id="sound-95" src="audio/math/95.mp3" preload="auto"></audio>
    <audio id="sound-96" src="audio/math/96.mp3" preload="auto"></audio>
    <audio id="sound-97" src="audio/math/97.mp3" preload="auto"></audio>
    <audio id="sound-98" src="audio/math/98.mp3" preload="auto"></audio>
    <audio id="sound-99" src="audio/math/99.mp3" preload="auto"></audio>
    <audio id="sound-100" src="audio/math/100.mp3" preload="auto"></audio>

    <!-- Alpine.js data object -->
    <script>
        function numbersIconApp() {
            return {
                numbers: Array.from({ length: 101 }, (_, i) => i), // Numbers from 0 to 100
                modalOpen: false, // For icon modal
                selectedNumberForIcons: 0, // Number selected for icon display
                displayedIcons: [], // Array to hold the src of icons to display
                selectedAnimalIcon: '', // Store the path of the single selected animal icon

                // Audio player elements
                numberSoundElements: {}, // To store references to individual number audio elements
                synth: window.speechSynthesis, // For potential TTS fallback

                // List of animal icon paths (TODO: Replace with your actual paths)
                animalIconPaths: [
                    'images/icons/animal_cat.png',
                    'images/icons/animal_dog.png',
                    'images/icons/animal_elephant.png',
                    'images/icons/animal_fish.png',
                    'images/icons/animal_lion.png',
                    'images/icons/animal_monkey.png',
                    'images/icons/animal_owl.png',
                    'images/icons/animal_pig.png',
                    'images/icons/animal_rabbit.png',
                    'images/icons/animal_zebra.png',
                    'images/icons/animal_bird.png',
                    'images/icons/animal_cow.png',
                    'images/icons/animal_frog.png',
                    'images/icons/animal_horse.png',
                    'images/icons/animal_mouse.png',
                    'images/icons/animal_snake.png',
                    'images/icons/animal_tiger.png',
                    'images/icons/animal_wolf.png',
                    // Add more animal icon paths here (ensure these paths are correct in your project)
                ],

                // Kurdish digits mapping
                kurdishDigits: ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'],

                init() {
                    console.log("Numbers with Icons App Initializing"); // Debugging log

                    // --- History API Setup ---
                    // Replace the initial history state. This is crucial.
                    // We set the initial state to point to the base page where the modal is closed.
                    // This ensures that the FIRST 'popstate' event from the modal goes to this state.
                     history.replaceState({ modal: false }, '', '');
                    console.log('Initial history state replaced:', history.state);

                    // Listen for the 'popstate' event (browser back/forward button or history.back()).
                    window.addEventListener('popstate', (event) => {
                        console.log('Popstate triggered', event.state);
                        // Check the state object.
                        if (event.state && event.state.modal === true) {
                            // If the state indicates the modal should be open, open it.
                            console.log('Popstate navigated to a modal state for number:', event.state.number);
                            this.selectedNumberForIcons = event.state.number;
                            this.generateAnimalIcons(this.selectedNumberForIcons);
                             // Only play sound if modal is NOT already open (avoids re-playing on forward nav into open modal state)
                            if (!this.modalOpen) {
                                 this.playNumberSound(this.selectedNumberForIcons);
                            }
                            this.modalOpen = true;
                             // Scroll modal content to top if needed
                            this.$nextTick(() => {
                                const modalContent = document.querySelector('.modal-content');
                                if (modalContent) {
                                    modalContent.scrollTo({top: 0, behavior: 'smooth'});
                                }
                            });

                        } else {
                             // If the state indicates modal should be closed (or is null/undefined).
                             console.log('Popstate navigated to a non-modal state.');
                             if (this.modalOpen) {
                                // If modal is currently open, close it without affecting history (popstate already changed history).
                                console.log('Modal was open, closing modal UI via popstate.');
                                this.closeModalWithoutHistoryChange(); // Use the function that only changes UI state
                            } else {
                                // If modal is already closed AND popstate happened, it means the user
                                // pressed back while on the main numbers grid page (or navigated here).
                                // According to the requirement, we should go to index.html.
                                // We explicitly navigate because the browser's default 'back' might just
                                // go to the state *before* the numbers page, which might not be index.html
                                // if the user navigated here differently.
                                console.log('Modal was closed, navigating to index.html as per requirement.');
                                // Check if the current URL is already index.html to avoid unnecessary navigation
                                if (window.location.pathname.split('/').pop() !== 'index.html' && window.location.pathname !== '/') {
                                     window.location.href = 'index.html';
                                } else {
                                    console.log('Already on index.html or root, preventing double navigation.');
                                }
                            }
                        }
                    });
                    // --- End History API Setup ---


                    // Initialize number sound elements (find them by ID)
                    this.$nextTick(() => { // Ensure DOM is ready and audio tags exist
                        for(let i = 0; i <= 100; i++) {
                            const soundElement = document.getElementById(`sound-${i}`);
                            if(soundElement) {
                                this.numberSoundElements[i] = soundElement;
                                soundElement.onerror = (e) => console.error(`Error loading audio for number ${i}:`, soundElement.src, e);
                            } else {
                                // Create a dummy object if element not found to prevent errors
                                console.warn(`Audio tag not found for number ${i}. Expected ID: sound-${i}. Using dummy.`);
                                this.numberSoundElements[i] = { play: () => { console.warn(`Dummy play for sound-${i}`); }, pause: () => {}, currentTime: 0 };
                            }
                        }
                        console.log('Number sound elements count:', Object.keys(this.numberSoundElements).length); // Debugging
                    });

                    // Stop sounds if the window/tab becomes inactive (optional but good practice)
                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden) {
                            this.stopAllSounds();
                            if (this.synth && this.synth.speaking) {
                                this.synth.cancel();
                            }
                        }
                    });

                     // Check if the page was loaded with a history state indicating modal open (e.g., after a refresh on modal page)
                    // This might not happen with simple pushState, but good for completeness.
                    // If we came from history back/forward into an open modal state on page load,
                    // the popstate listener above handles it immediately. This check might be redundant
                    // if the popstate listener is guaranteed to fire on page load when navigating history.
                     /*
                    if (history.state && history.state.modal === true) {
                         console.log('Page loaded with modal history state, opening modal.');
                         this.selectedNumberForIcons = history.state.number;
                         this.generateAnimalIcons(this.selectedNumberForIcons);
                         this.playNumberSound(this.selectedNumberForIcons);
                         this.modalOpen = true;
                    }
                    */

                },

                // Convert Western number to Kurdish digits string
                toKurdishDigits(number) {
                    return String(number).split('').map(digit => {
                        if (digit === '.') return '.';
                        const westernDigit = parseInt(digit, 10);
                        return isNaN(westernDigit) ? digit : this.kurdishDigits[westernDigit];
                    }).join('');
                },

                // --- Sound Control ---
                stopAllSounds() {
                    // Stop all currently playing number sounds
                    Object.values(this.numberSoundElements).forEach(audio => {
                         // Check if audio exists and has pause/currentTime properties (handles dummy objects)
                        if (audio && typeof audio.pause === 'function' && typeof audio.currentTime !== 'undefined' && !audio.paused) {
                            audio.pause();
                            audio.currentTime = 0;
                        }
                    });
                    if (this.synth && this.synth.speaking) { // Also stop TTS fallback if it was used
                        this.synth.cancel();
                    }
                },

                playNumberSound(number) {
                    console.log("Attempting to play sound for number:", number); // Debugging log
                    const soundElement = this.numberSoundElements[number];
                     // Check if soundElement is a valid audio element object
                    if (soundElement && soundElement instanceof HTMLAudioElement) {
                        this.stopAllSounds(); // Stop any other number sound or TTS
                        soundElement.currentTime = 0; // Reset to start
                        soundElement.play().catch(error => console.error(`Error playing sound for number ${number}:`, error));
                    } else {
                        console.warn(`Sound element not found or is not an audio element for number ${number}. Check audio tags and paths.`);
                        // Fallback: Text-to-Speech for numbers if audio is missing (optional)
                        if (window.speechSynthesis && this.synth) {
                            this.synth.cancel(); // Stop any other TTS
                            const utterance = new SpeechSynthesisUtterance(number.toString()); // Speak the actual number string (e.g., "25")
                            // Attempt to find a suitable voice, prioritizing English or Kurdish (if available)
                            const voices = this.synth.getVoices();
                            let voice = voices.find(v => v.lang === 'ckb-IQ' || v.lang === 'ckb-IR'); // Check for Kurdish voice
                            if (!voice) {
                                voice = voices.find(v => v.lang.startsWith('en') && (v.name.toLowerCase().includes('child') || v.name.toLowerCase().includes('male'))); // Fallback to English child/male voice
                            }
                             if (!voice) {
                                voice = voices.find(v => v.lang.startsWith('en')); // Any English voice
                            }
                            if (voice) utterance.voice = voice;
                             utterance.lang = voice ? voice.lang : 'en-US'; // Set language based on chosen voice or default to en-US
                            this.synth.speak(utterance);
                            utterance.onerror = (event) => {
                                console.error('TTS fallback error for number:', number, event);
                            };
                        }
                    }
                },

                // --- Numbers with Icons Section Functions ---
                generateAnimalIcons(count) {
                    if (count === 0) {
                        this.displayedIcons = [];
                        this.selectedAnimalIcon = '';
                        return;
                    }
                    const numAnimals = this.animalIconPaths.length;
                    if (numAnimals === 0) {
                        console.warn("No animal icons available in animalIconPaths array.");
                        this.displayedIcons = [];
                        this.selectedAnimalIcon = '';
                        return;
                    }

                    // Pick one random animal type for this number
                    const randomIndex = Math.floor(Math.random() * numAnimals);
                    this.selectedAnimalIcon = this.animalIconPaths[randomIndex];

                    // Create an array with the selected icon path repeated 'count' times
                    this.displayedIcons = Array(count).fill(this.selectedAnimalIcon);
                    console.log(`Generated ${count} icons of type: ${this.selectedAnimalIcon}`); // Debugging log
                },

                 // Function to close modal UI state without affecting browser history
                 // Used by the popstate listener when navigating AWAY from a modal state
                 closeModalWithoutHistoryChange() {
                     console.log("Closing modal UI state (no history change)");
                     if (this.modalOpen) { // Only perform actions if modal is currently open
                        this.modalOpen = false;
                        this.selectedNumberForIcons = 0; // Reset icon count
                        this.displayedIcons = []; // Clear icons array
                        this.selectedAnimalIcon = ''; // Clear selected animal icon
                        this.stopAllSounds(); // Stop sounds when modal closes
                        // No history action here, as popstate already handled it
                     }
                 },

                // Function to open modal and handle history state
                openIconModal(number) {
                    console.log("Opening icon modal for number:", number);

                    // Only proceed if modal is not already open for the same number
                    if (this.modalOpen && this.selectedNumberForIcons === number) {
                         console.log(`Modal already open for number ${number}. Skipping.`);
                         return; // Do nothing if already open for this number
                    }
                     // If modal is open for a *different* number, closing it and reopening it
                     // might be complex with history. For this design, we assume clicks
                     // happen only when the modal is closed.

                    this.selectedNumberForIcons = number;
                    this.generateAnimalIcons(number);
                    // Play the number sound when the modal opens
                    this.playNumberSound(number);

                    // Set modalOpen to true *before* pushing history state
                    this.modalOpen = true;

                    // Add a new entry to the browser history stack.
                    // This state indicates the modal is open for this specific number.
                    history.pushState({ modal: true, number: number }, '', ''); // Empty title and URL (keeps current URL)
                    console.log('History state pushed:', history.state);

                    // Scroll modal content to top on next tick after DOM updates
                    this.$nextTick(() => {
                        const modalContent = document.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.scrollTo({top: 0, behavior: 'smooth'});
                        }
                    });
                },

                // Function called by UI elements (modal back button, backdrop) to close the modal
                // This function initiates the browser history back action.
                closeModalFromUI() {
                    console.log("Closing modal from UI element, initiating history.back()");
                    if (this.modalOpen) { // Only do this if the modal is currently open
                        // This will trigger the 'popstate' event listener.
                        // The popstate listener will see that the state navigated TO is NOT a modal state,
                        // and it will call closeModalWithoutHistoryChange() to update the UI.
                        history.back();
                    } else {
                        console.warn("closeModalFromUI called but modal is not open.");
                        // If somehow called when modal is not open, maybe explicitly go back?
                        // window.history.back(); // Uncomment if you want this button to always go back
                    }
                },

                // Computed property/function to dynamically calculate icon size class based on number
                iconSizeClass() {
                    if (this.selectedNumberForIcons === 0) return ''; // No icons

                    // Adjust size thresholds based on the expected grid layout (5 or 10 columns)
                    if (this.selectedNumberForIcons <= 5) return 'xlarge'; // Very few, very large (fits 5-col)
                    if (this.selectedNumberForIcons <= 10) return 'large'; // Still few, large (fits 5-col)
                    if (this.selectedNumberForIcons <= 40) return 'medium'; // Up to 40 (fits well in 5 columns with medium size)
                    // For numbers > 40 (which use 10 columns), use small size to fit more icons
                    return 'small';
                },

                // Computed class for the icon container grid layout (5 or 10 columns)
                iconGridClass() {
                    if (this.selectedNumberForIcons === 0) return ''; // No grid needed for 0
                    // Apply 5-column grid for numbers 1 through 40
                    if (this.selectedNumberForIcons <= 40) return 'icons-grid-5-per-row';
                    // Apply 10-column grid for numbers 41 through 100
                    return 'icons-grid-10-per-row';
                }
            }
        }
    </script>
</body>
</html>